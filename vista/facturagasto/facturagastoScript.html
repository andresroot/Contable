{{define "facturagastoscript" }}
<script>
    function limpiarformatoEnviar(cnumero) {
        if (cnumero=="")
        {cnumero="0";}

        cnumero = cnumero.replace("$", "");
        cnumero = cnumero.replace(/,/g, '');

        console.log("limpianumero");
        console.log(cnumero);
        return (cnumero)
    }

    var numeroPanel = 1;
    $(document.body).on('focusout', '#PorcentajeRetencionFuente', function (e) {
        totales();
    });

    $(document.body).on('focusout', '#PorcentajeRetencionIca', function (e) {
        totales();
    });

    // llena los datos del producto
    function llenarFila(numeroFila) {
        elemento = '#seleccion_producto' + numeroFila;
        productoCodigo = $(elemento).val();
        unidad = '#unidad' + cont;
        impuesto = '#iva' + cont;
        nombre = '#nombre' + cont;
        var datosEnviar = {
            "productoCodigo": productoCodigo
        };

        accion = "/ProductoActual/" + productoCodigo;
        $.ajax({
            url: accion,
            type: "GET",
            async: false,
            data: JSON.stringify(datosEnviar),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            error: function (response) {
            },

            success: function (response) {
                if (jQuery.isEmptyObject(response)) {
                    $(unidad).html('');
                    $(impuesto).html('');
                    $(nombre).html('');
                } else {
                    $.each(response, function (i, item) {
                        $(unidad).html(item.Unidad);
                        $(impuesto).html(item.Iva);
                        $(nombre).html(item.Nombre);
                    });
                }
            }
        });
    }

    function autocompletaTercero(obj) {
        // autocompelta tercero
        $(document.body).on('focusout', obj, function (e) {
            //alert("dasda");
            if ($(obj).val() == '') {
            } else {
                terceroCodigo = $(obj).val();
                var datosEnviar = {
                    "terceroCodigo": terceroCodigo
                };
                accion = "/TerceroActual/" + terceroCodigo;

                $.ajax({
                    url: accion,
                    type: "GET",
                    async: false,
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    error: function (response) {
                        alert('No Existe Tercero');
                        //alert(response.responseText);
                        // productoCodigo = $(obj).val('');
                    },
                    success: function (response) {
                        if (jQuery.isEmptyObject(response)) {
                            alert('No Existe Tercero');
                            $('#terceroNombre').val('');
                        } else {
                            $.each(response, function (i, item) {
                                $('#terceroDv').val(item.Dv);
                                $('#terceroNombre').val(item.Nombre);
                                $('#terceroDireccion').val(item.Direccion);
                                $('#terceroTelefono1').val(item.Telefono1);
                                $('#terceroEmail1').val(item.Email1);
                                $("#PorcentajeRetencionIca").val(item.Ica);
                            });
                        }
                    }
                });
            }
        });

        $(obj).autocomplete({
            source: function (request, response) {
                $.ajax({
                    url: "/TerceroBuscar/" + request.term.replace(/\./g, ''),
                    type: 'GET',
                    dataType: "json",
                    success: function (data) {
                        response(data);
                    }
                });
            },
            messages: {
                noResults: '',
                results: function () {
                }
            },
            maxShowItems: 5,
            response: function (event, ui) {
                // Add the "button" object to the list of suggestions:
                //  if (ui.content.length === 0) {
                $('#terceroNuevo').val($(obj).val());
                ui.content.push({
                    label: " Crear Tercero :  " + $('#terceroNuevo').val(),
                    button: true
                });
            },

            select: function (event, ui) {
                var label = ui.item.label;
                var value = ui.item.value;
                valor = $(obj).val();
                // alert(label);
                //alert( $('#terceroNuevo').val());
                valorBuscar = " Crear Tercero :  " + $('#terceroNuevo').val();
                if (label == valorBuscar) {
                    valor = $('#terceroNuevo').val();
                    panelListaFacturaGasto('TerceroNuevo', 'True', valor, obj.replace('#', ''))
                } else {
                    elemento = obj;
                    $('terceroNombre').html(ui.item.Nombre);
                }
                //store in session
            },
            open: function (event, ui) {
            }
        });
    }

    function totales() {
        var Subtotal = 0;
        var Subtotal19 = 0;
        var Subtotal5 = 0;
        var Subtotal0 = 0;
        var Descuento = 0;
        var SubtotalIva19 = 0;
        var SubtotalIva5 = 0;
        var SubtotalIva0 = 0;
        var SubtotalBase19 = 0;
        var SubtotalBase5 = 0;
        var SubtotalBase0 = 0;
        var Total = 0;
        var TotalIva = 0;
        var PorcentajeRetencionFuente = 0;
        var TotalRetencionFuente = 0;
        var PorcentajeRetencionIca = 0;
        var TotalRetencionIca = 0;
        var Neto = 0;
        var cont = 1;
        var subtotalLineaTotal = 0;
        var SubtotalDescuento=0;
        var SubtotalDescuento19=0;
        var SubtotalDescuento5=0;
        var SubtotalDescuento0=0;
        $('#tabla tbody tr').each(function () {
            subtotalLinea = 0;
            fila = cont;
            iva = $("#iva" + cont).html();
            descuento = 0;
            cantidad = limpiarformato($("#cantidad" + cont).val());
            valor = limpiarformato($("#valor" + cont).val());
            valorDescuento = cantidad * ((valor * descuento) / 100);
            SubtotalDescuento = SubtotalDescuento + valorDescuento;
            subtotalLinea = (cantidad * valor);
            subtotalLineaTotal = subtotalLineaTotal + (cantidad * valor);

           SubtotalBase0 = SubtotalBase0 + subtotalLinea;
           Subtotal0 = Subtotal0 + subtotalLinea;
           SubtotalIva0 = 0;
           SubtotalDescuento0 = SubtotalDescuento0 + valorDescuento;
           textoSubtotal = '' + subtotalLinea;
           $("#total" + cont).html(formatomoneda(textoSubtotal));
           cont++;
        });

        $("#Subtotal19").val(formatomoneda(Subtotal19.toFixed(0)));
        $("#Subtotal5").val(formatomoneda(Subtotal5.toFixed(0)));
        $("#Subtotal0").val(formatomoneda(Subtotal0.toFixed(0)));
        Subtotal = Subtotal19 + Subtotal5 + Subtotal0;
        $("#Subtotal").val(formatomoneda(Subtotal.toFixed(0)));
        SubtotalBase19=SubtotalBase19-SubtotalDescuento19;
        SubtotalBase5=SubtotalBase5-SubtotalDescuento5;
        SubtotalBase0=SubtotalBase0-SubtotalDescuento0;
        Subtotal = SubtotalBase19 + SubtotalBase5 + SubtotalBase0+SubtotalDescuento;
        SubtotalBase = SubtotalBase19 + SubtotalBase5 + SubtotalBase0
        Descuento = SubtotalDescuento;
        TotalIva = SubtotalIva19 + SubtotalIva5;
        Total = SubtotalBase19 + SubtotalBase5 + SubtotalBase0 + SubtotalIva19 + SubtotalIva5;
        $("#Descuento").val(formatomoneda(Descuento.toFixed(0) + ""));
        $("#SubtotalIva19").val(formatomoneda(SubtotalIva19.toFixed(0)));
        $("#SubtotalIva5").val(formatomoneda(SubtotalIva5.toFixed(0)));
        $("#SubtotalBase19").val(formatomoneda(SubtotalBase19.toFixed(0)));
        $("#SubtotalBase5").val(formatomoneda(SubtotalBase5.toFixed(0)));
        $("#SubtotalBase0").val(formatomoneda(SubtotalBase0.toFixed(0)));
        $("#SubtotalDescuento19").val(formatomoneda(SubtotalDescuento19.toFixed(0)));
        $("#SubtotalDescuento5").val(formatomoneda(SubtotalDescuento5.toFixed(0)));
        $("#SubtotalDescuento0").val(formatomoneda(SubtotalDescuento0.toFixed(0)));
        $("#Subtotal").val(formatomoneda(Subtotal.toFixed(0)));
        $("#TotalIva").val(formatomoneda(TotalIva.toFixed(0)));
        $("#Total").val(formatomoneda(Total.toFixed(0)));

        PorcentajeRetencionFuente = $("#PorcentajeRetencionFuente").val();
        TotalRetencionFuente = SubtotalBase * (PorcentajeRetencionFuente / 100);
        $("#TotalRetencionFuente").val(formatomoneda(TotalRetencionFuente.toFixed(0)));

        PorcentajeRetencionIca = $("#PorcentajeRetencionIca").val().replace('%', '');
        TotalRetencionIca = SubtotalBase * (PorcentajeRetencionIca / 100);
        $("#TotalRetencionIca").val(formatomoneda(TotalRetencionIca.toFixed(0)));

        PorcentajeIva = $("#Facturagastoporcentajeiva").val();
        TotalIva = SubtotalBase * (PorcentajeIva / 100);
        $("#TotalIva").val(formatomoneda(TotalIva.toFixed(0)));

        Neto = Total - TotalRetencionFuente - TotalRetencionIca + TotalIva;

        $("#Neto").val(formatomoneda(Neto.toFixed(0)));
        $("#Items").val(cont - 1);
    }

    // FUNCION GUARDAR
    function guardardoc(accion) {
        if(validaDatos()==false)
        {
            return;
        }

        // valores cabecera
        Codigo = $('#Codigo').val();
        Fecha1 = $('#Fecha').val();
        Vence1 = $('#Vence').val();
        var Fecha = moment(Fecha1).format("YYYY-MM-DDTHH:mm:ssZ");
        var Vence = moment(Vence1).format("YYYY-MM-DDTHH:mm:ssZ");
        Plazo = $('#Plazo').val();
        Tercero = $('#terceroCodigo').val().replace(/\./g, '');
        Subtotal = limpiarformatoEnviar($('#Subtotal').val());
        Subtotal19 = '0'
        Subtotal5 = '0'
        Subtotal0 = limpiarformatoEnviar($('#Subtotal').val());
        Descuento = '0'
        SubtotalDescuento19 = '0'
        SubtotalDescuento5 = '0'
        SubtotalDescuento0 = '0'
        SubtotalIva19 = '0'
        SubtotalIva5 = '0'
        SubtotalIva0 = '0';
        SubtotalBase19 = '0'
        SubtotalBase5 ='0'
        SubtotalBase0 = '0'
        TotalIva = limpiarformatoEnviar($('#TotalIva').val());
        Total = limpiarformatoEnviar($('#Total').val());
        PorcentajeRetencionFuente = $('#PorcentajeRetencionFuente').val();
        TotalRetencionFuente = limpiarformatoEnviar($('#TotalRetencionFuente').val());
        PorcentajeRetencionIca = $('#PorcentajeRetencionIca').val();
        TotalRetencionIca = limpiarformatoEnviar($('#TotalRetencionIca').val());
        Neto =limpiarformatoEnviar( $('#Neto').val());
        Mediodepago = $('#Mediodepago').val();
        Formadepago = $('#Formadepago').val();
        Almacenista = $('#Almacenista').val();
        Pedidofacturagasto = $('#Pedidofacturagasto').val();
        Tipo = "Facturagasto";
        Centro = $('#Centro').val();
        console.log("prueba 444");
        Facturagastocuenta0 = $('#Facturagastocuenta0').val();
        Facturagastonombre0 = $('#Facturagastonombre0').val();

        Facturagastocuentaretfte = $('#Facturagastocuentaretfte').val();
        Facturagastonombreretfte = $('#Facturagastonombreretfte').val();

        Facturagastocuentaiva = $('#Facturagastocuentaiva').val();
        Facturagastonombreiva = $('#Facturagastonombreiva').val();
        Facturagastoporcentajeiva = $('#Facturagastoporcentajeiva').val();

        // cuenta filas
        var filas = 0;
        $('#tabla tbody tr').each(function () {
            // if ($("#seleccion_producto" + filas).val() == '') {
            //  } else {
           filas++;
        });

        Items = filas + " ";

        // DATOS ENVIAR
        var datosEnviar = {
            "Accion": accion,
            "Detalle": [],
            "Codigo": Codigo,
            "Fecha": Fecha,
            "Vence": Vence,
            "Plazo": Plazo,
            "Tercero": Tercero,
            "Subtotal": Subtotal,
            "Subtotal19": Subtotal19,
            "Subtotal5": Subtotal5,
            "Subtotal0": Subtotal0,
            "Descuento": Descuento,
            "SubtotalDescuento19": SubtotalDescuento19,
            "SubtotalDescuento5": SubtotalDescuento5,
            "SubtotalDescuento0": SubtotalDescuento0,
            "SubtotalIva19": SubtotalIva19,
            "SubtotalIva5": SubtotalIva5,
            "SubtotalIva0": SubtotalIva0,
            "SubtotalBase19": SubtotalBase19,
            "SubtotalBase5": SubtotalBase5,
            "SubtotalBase0": SubtotalBase0,
            "TotalIva": TotalIva,
            "Total": Total,
            "PorcentajeRetencionFuente": PorcentajeRetencionFuente,
            "TotalRetencionFuente": TotalRetencionFuente,
            "PorcentajeRetencionIca": PorcentajeRetencionIca,
            "TotalRetencionIca": TotalRetencionIca,
            "Neto": Neto,
            "Formadepago": Formadepago,
            "Mediodepago": Mediodepago,
            "Almacenista": Almacenista,
            "Pedidofacturagasto": Pedidofacturagasto,
            "Items": Items,
            "Tipo": Tipo,
            "Centro": Centro,
            "Facturagastocuenta0": Facturagastocuenta0,
            "Facturagastonombre0": Facturagastonombre0,
            "Facturagastocuentaretfte": Facturagastocuentaretfte,
            "Facturagastonombreretfte": Facturagastonombreretfte,
            "Facturagastocuentaiva": Facturagastocuentaiva,
            "Facturagastonombreiva": Facturagastonombreiva,
            "Facturagastoporcentajeiva": Facturagastoporcentajeiva,
        };

        var MovimientoValido = true;
        // valida r movimiento
        ultimo = Items;
        // alert(ultimo);

        // borra ultimo
        if ($("#seleccion_producto" + ultimo).val() == '' || $("#cantidad" + ultimo).val() == '' || $("#valor" + ultimo).val() == '') {
            eliminar(ultimo);
            // alert("Borrar Ultimo");
        }

        // REVISA QUE TODOS ESTEN COMPLETOS
        var cont = 1;
        $('#tabla tbody tr').each(function () {
            // fila = cont;
            if ($("#seleccion_producto" + cont).val() == '' || $("#cantidad" + cont).val() == '' || $("#valor" + cont).val() == '') {
                MovimientoValido = false;
            }
            cont++;
        });

        if (MovimientoValido = false) {
            // alert("Llenar Items")
            siEnvio = false;
            alert("Completar La Informaci√≥n De Filas");
            return true;
        }

        var cont = 1;
        var filavalida = 0;
        $('#tabla tbody tr').each(function () {
            fila = cont;
            if ($("#seleccion_producto" + cont).val() == '' && $("#cantidad" + cont).val() == '' && $("#valor" + cont).val() == '') {
            } else {
                bodega = $("#seleccion_bodega" + cont).val();
                cantidad = $("#cantidad" + cont).val();
                precio = $("#valor" + cont).val();
                descuento = $("#descuento" + cont).val();
                subtotal = $("#total" + cont).html();
                fila = cont + " ";
                Codigoservicio = $("#seleccion_producto" + cont).val();
                Nombreservicio = $("#nombre" + cont).val();
                Unidadservicio = $("#unidad" + cont).val();
                id = "";
                pagina = "";
                montodescuento = "";
                sigratis = "";
                subtotaldescuento = "";

                // DATOS ENVIAR DETALLE
                datosEnviar.Detalle.push({
                    "Id": id,
                    "Codigo": Codigo,
                    "Fila": fila,
                    "Cantidad": cantidad,
                    "Precio": precio,
                    "Subtotal": subtotal,
                    "Pagina": pagina,
                    "Bodega": bodega,
                    "Codigoservicio": Codigoservicio,
                    "Nombreservicio": Nombreservicio,
                    "Unidadservicio": Unidadservicio,
                    "Descuento": descuento,
                    "Montodescuento": montodescuento,
                    "Sigratis": sigratis,
                    "Subtotaldescuento": subtotaldescuento,
                    "Tipo": Tipo,
                    "Fecha": Fecha,
                });
                filavalida++;
            }
            cont++;
        });

        // JSON.stringify(datosEnviar)
        console.log(JSON.stringify(datosEnviar));
        var siEnvio = true;

        if (siEnvio == true) {

            // enviar
            accion = "/FacturagastoAgregar";
            $.ajax({
                url: accion,
                type: "POST",
                async: false,
                data: JSON.stringify(datosEnviar),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (respuesta) {
                    if (respuesta.result == true) {
                        alert("Documento Guardado Correctamente");
                        document.location.href = '/FacturagastoLista';
                    } else {
                        alert("Ocurrio Un Error Al Guardar");
                    }
                },
            });
        }
    }

    var cont = 0
    var id_fila_selected;

    //Agregar Linea
    function filas()
    {
        var cuenta_fila = 1;
        $('#tabla tbody tr').each(function () {
            cuenta_fila++;
        });

        return cuenta_fila-1;
    }

    function agregar() {
        // cont++;
        var cont = 1;
        $('#tabla tbody tr').each(function () {
            cont++;
        });

        //cont=cont+1;
        var fila = '<tr  id = \"fila' + cont + '\">';

        fila = fila + "<td  style=\"width: 10px\"  class=\"celdaAccion\"><a onclick=\"insertar('fila" + cont + "')\" ><i class=\"fas fa-plus-circle mt-0 color\" style=\"color:#21B799\"></i></a><td>";

        fila = fila + "<td><div style=\"width: 50px\" class=\"celdaFila\" id=\"Fila" + cont + '\">' + cont + '</div></td>';

        fila = fila + "<td>";
        fila = fila + "<input class=\"celdaProducto\" maxlength=\'4\' style=\"width: 150px\" type=\"text\" value=\"\" id=\"seleccion_producto" + cont + '"\  \>';
        fila = fila + '</td>';

        fila = fila + "<td><textarea  class=\"celdaNombreServicio\" id=\"nombre" + cont + '"\  \></textarea>';
        fila = fila + '</td>';

        fila = fila + "<td ><input style=\"width: 100px\" class=\"celdaUnidad\" maxlength=\'6\' value=\"\" id=\"unidad" + cont + '"\  \>';
        fila = fila + '</td>';

        fila = fila + "<td><input style=\"width: 120px\" pattern=\"^\\$\\d{1,3}(,\\d{3})*(\\.\\d+)?$\" data-type=\"currency\" class=\"inputNumero\" type=\"text\" value=\"\" id=\"cantidad" + cont + '"\ /></td>';

        fila = fila + "<td><input style=\"width: 120px\" pattern=\"^\\$\\d{1,3}(,\\d{3})*(\\.\\d+)?$\" data-type=\"currency\" class=\"inputNumero\" type=\"text\" value=\"\" id=\"valor" + cont + '"\ /></td>';

        fila = fila + "<td ><div style=\"width: 150px\" class=\"inputTotal\" id=\"total" + cont + '\">0</div></td>';

        fila = fila + "<td  style=\"width: 20px\"  class=\"celdaAccion\"><a onclick=\"eliminar('fila" + cont + "')\" ><i class=\"fas fa-trash-alt mt-0\" style=\"color:#E74C3C\"></i></a><td>";

        fila = fila + '</tr>';

        $('#tabla tbody').append(fila);
        //console.log(fila);
        $("#nombre" + cont).each(function () {

            if (this.value=="")
            {
                this.setAttribute("style", "width: 370px; height:14px;overflow-y:hidden;");
            }
            else
            {
                this.setAttribute("style", "height:" + (this.scrollHeight-10) + "px;overflow-y:hidden;");
            }

        }).on("input", function () {
            this.style.height = "auto";
            this.style.height = (this.scrollHeight) + "px";

        });

        // formato Valor
        elemento = "#nombre" + cont;
        $(document.body).on('focusout', elemento, function (e) {
            this.style.height = "14px";
        });

        elemento = "#nombre" + cont;
        $(document.body).on('focusin', elemento, function (e) {
            this.style.height = "auto";
            this.style.height = (this.scrollHeight) + "px";
        });

        reordenar();
        totales();

        // formato cantidad
        elemento = '#cantidad' + cont;
        $(document.body).on('focusout', elemento, function (e) {
            totales();
        });
        $(document).on('keyup', elemento, function (e) {
            e.preventDefault();
            formatCurrency($(this));
        });

        // formato Valor
        elemento = '#valor' + cont;
        $(document.body).on('focusout', elemento, function (e) {
            totales();
        });

        $(document).on('keyup', elemento, function (e) {
            e.preventDefault();
            // var code = e.keyCode || e.which;
            if (e.which == 13) {
            // agregar();
            } else {
                formatCurrency($(this));
            }
        });

        // valor
        elemento = '#valor' + cont;
        $(document).on('keyup', elemento, function (e) {
            //   e.preventDefault();
            var code = e.keyCode || e.which;

            if (e.which == 13) {
               // agregar()
                cont = this.id.replace('valor', '');
                id = parseInt(cont) + 1;
                producto = 'seleccion_producto' + id;
                seleccion="seleccion_producto"+cont;
                if(cont==filas() &&    $('#' + seleccion).val()!="" )
                {
                    agregar();
                }

                //alert(producto);
                $('#' + producto).focus();
                $('#' + producto).focusin();
            } else {
                formatCurrency($(this));
            }
        });

        $(document).on('keydown', elemento, function (e) {
            //e.preventDefault();
            var code = e.keyCode || e.which;
            if (code === 9) {
                e.preventDefault();
                // agregar()
                cont = this.id.replace('valor', '');
                id = parseInt(cont) + 1;
                actual=parseInt(cont) ;
                producto = 'seleccion_producto' + id;
                seleccion="seleccion_producto"+cont;
                if(cont==filas() &&    $('#' + seleccion).val()!="" )
                {
                    agregar();

                    // copia bodega al siguiente
                    if(  $("#seleccion_bodega" + actual).val()!="")
                    {
                        $("#seleccion_bodega" + id).val( $("#seleccion_bodega" + actual).val());
                    }
                }

                //alert(producto);
                $('#' + producto).focus();
                $('#' + producto).focusin();
            }
        });
    }

    function insertar(id_fila) {
        agregar();

        filaActual=id_fila.replace("fila","");
        NumeroActual=parseInt(filaActual);
        var cont = 1;
        $('#tabla tbody tr').each(function () {
            cont++;
        });

        for (var j = cont-1; j >=filaActual ; j--) {
            cadenaActual=""+j;
            lineaSuperior=j-1;
            cadenaSuperior=lineaSuperior+"";
            $("#seleccion_producto"+cadenaActual).val($("#seleccion_producto"+cadenaSuperior).val());
            $("#nombre"+cadenaActual).html($("#nombre"+cadenaSuperior).html());
            $("#unidad"+cadenaActual).html($("#unidad"+cadenaSuperior).html());
            $("#iva"+cadenaActual).html($("#iva"+cadenaSuperior).html());
            $("#cantidad"+cadenaActual).val($("#cantidad"+cadenaSuperior).val());
            $("#valor"+cadenaActual).val($("#valor"+cadenaSuperior).val());
            $("#total"+cadenaActual).val($("#total"+cadenaSuperior).val());
        }

        cadenaActual=filaActual;
        $("#seleccion_producto"+cadenaActual).val("");
        $("#nombre"+cadenaActual).html("");
        $("#unidad"+cadenaActual).html("");
        $("#iva"+cadenaActual).html("");
        $("#cantidad"+cadenaActual).val("");
        $("#valor"+cadenaActual).val("");
        $("#total"+cadenaActual).val("");
        totales();
        reordenar();
    }

    function eliminar(id_fila) {
        //agregar();
        var cont = 1;
        $('#tabla tbody tr').each(function () {
            cont++;
        });

        if ((cont-1)>1)
        {
            filaActual=id_fila.replace("fila","");
            NumeroActual=parseInt(filaActual);
            lineaSuperior=0;
            for (var j = filaActual; j <cont-1 ; j++) {
                cadenaActual=""+j;
                lineaSuperior=parseInt(j)+1;
                cadenaSuperior=lineaSuperior+"";
                $("#seleccion_producto"+cadenaActual).val($("#seleccion_producto"+cadenaSuperior).val());
                $("#nombre"+cadenaActual).html($("#nombre"+cadenaSuperior).html());
                $("#unidad"+cadenaActual).html($("#unidad"+cadenaSuperior).html());
                $("#iva"+cadenaActual).html($("#iva"+cadenaSuperior).html());
                $("#cantidad"+cadenaActual).val($("#cantidad"+cadenaSuperior).val());
                $("#valor"+cadenaActual).val($("#valor"+cadenaSuperior).val());
                $("#total"+cadenaActual).val($("#total"+cadenaSuperior).val());
            }
            var fila=cont-1;
            $('#fila' +fila ).remove();
        }

        totales();
    }

    function reordenar() {
        var num = 1;
        $('#tabla tbody tr').each(function () {
            $(this).attr('id', 'fila' + num);
            $('Fila' + num).html(num);
            num++;
        });
    }

    // cierra panel
    window.document.addEventListener('myEvent', handleEvent, false)

    function handleEvent(e) {
        if (e.detail.valido == true) {
            //alert(e.detail.codigoElemento);

            if (e.detail.elementoPanel == "terceroCodigo") {
                valor = e.detail.codigoElemento.replace('.', '');
            } else {
                valor = e.detail.codigoElemento;
            }

            $('#' + e.detail.elementoPanel).val(valor);
            $('#' + e.detail.elementoPanel).focus();
            panelNuevo.close();
        } else {
            panelNuevo.close();
        }

        console.log(e.detail) // outputs: {foo: 'bar'}
    }

    function panelListaFacturaGasto(modulo, panel, parametro, elemento) {
        numeroPanel = numeroPanel + 1;
        cadenaPanel = "panel" + numeroPanel;
        url = '/' + modulo + '/' + panel + '/' + parametro + '/' + elemento;
        url = "<iframe src=\'" + url + "\' width=\'100%\' height=\'100%\' style=\'padding: 15px;\'></iframe>";
        panelNuevo = jsPanel.create({
            theme: {
                bgContent: '#fff',
                colorHeader: 'black',
                border: '1px #A8A8A8 solid'
            },
            headerControls: {
                maximize: 'remove',
                size: 'xs'
            },
            id: cadenaPanel,
            size: {width: 800, height: 500},
            contentSize: {width: '1306px', height: '500px'}, // must be object
            content: url,
            position: {
                top: '350px',
                left: '600px',
                maxTop: '-20px',
            },
            headerTitle: 'Sadconf Cloud 1.0'
        });
    }

    function validaDatos()
    {
        tercero_valido = true;
        numero_valido = true;
        ultimo = filas()+"";
        // borra ultimo
        if ($("#seleccion_producto" + ultimo).val() == '' || $("#cantidad" + ultimo).val() == '' || $("#valor" + ultimo).val() == '') {
            eliminar(ultimo);
            // alert("Borrar Ultimo");
        }
        textovalidar="";
        cabeceravalida=true;
        fechavalida=true;
        vencevalida=true;

        // fecha valida
        if (moment($('#Fecha').val()).isValid()==false )
        {
            textovalidar+='\n Fecha Factura No Valida';
            cabeceravalida=false;
            fechavalida=false;
        }

        if ( moment($('#Vence').val()).isValid()==false)
        {
            textovalidar+='\n Fecha Vence No Valida';
            cabeceravalida=false;
            vencevalida=false;
        }

        if (vencevalida==true && vencevalida==true)
        {
            if(moment($('#Vence').val()).isBefore(moment($('#Fecha').val())))
            {
                textovalidar+='\n Fecha Vence Debe ser igual o Mayor que Fecha';
                cabeceravalida=false;
            }
        }

        if ($("#Codigo").val() == '') {
            textovalidar+='\n Por Favor Digite No. de Factura';
            cabeceravalida=false;
        }

        if ($("#terceroCodigo").val() == '') {
            textovalidar+='\n Por Favor Digite Un Proveedor';
            cabeceravalida=false;
        }

        if ($("#FormadepagoNombre").val() == '') {
            textovalidar+='\n Por Favor Digite Una Forma De Pago';
            cabeceravalida=false;
        }

        if ($("#Mediodepago").val() == '') {
            textovalidar+='\n Por Favor Digite Un Medio De Pago';
            cabeceravalida=false;
        }

        if ($("#Almacenista").val() == '') {
            textovalidar+='\n Por Favor Digite Un Almacenista';
            cabeceravalida=false;
        }

        if ($("#Centro").val() == '') {
            textovalidar+='\n Por Favor Digite Un Centro';
            cabeceravalida=false;
        }

        if ($("#Facturagastocuenta0").val() == '') {
            textovalidar+='\n Por Favor Digite Una Cuenta Gasto';
            cabeceravalida=false;
        }

        // cabeceravalida=true;

        if ( cabeceravalida==false)
        {
            alert(textovalidar);
        }

        var cont = 1;
        Mensaje = "";
        MovimientoValido = true;

        validaMovimiento="";
        $('#tabla tbody tr').each(function () {
            // fila = cont;

            if ($("#seleccion_producto" + cont).val() == '') {
                validaMovimiento+='\n Por Favor Digite Codigo del Producto';
                MovimientoValido = false;
            }

            if ($("#Nombre" + cont).val() == '') {
                validaMovimiento+='\n Por Favor Digite el Servicio';
                MovimientoValido = false;
            }

            if ($("#Unidad" + cont).val() == '') {
                validaMovimiento+='\n Por Favor Digite la Unidad';
                MovimientoValido = false;
            }

            if ($("#cantidad" + cont).val() == '' || $("#cantidad" + cont).val() == '0') {
                validaMovimiento+='\n Por Favor Digite Cantidad';
                MovimientoValido = false;
            }

            if ($("#valor" + ultimo).val() == '' || $("#valor" + ultimo).val() == '0') {
                validaMovimiento+='\n Por Favor Digite Valor Unitario';
                MovimientoValido = false;
            }
            cont++;
        });

        if ( MovimientoValido == false)
        {
            alert(validaMovimiento)
        }

        if(cabeceravalida==true && MovimientoValido == true)
        {
            return true;
        }
        else {
            return false;
        }
    }
</script>
{{end}}
